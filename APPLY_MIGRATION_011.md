# Применение миграции 011: Проверка уникальности email

## Что было исправлено
Добавлена RPC функция для проверки уникальности email, которая обходит ограничения RLS.

## Как применить миграцию

### Вариант 1: Через Supabase Dashboard
1. Откройте https://supabase.com/dashboard
2. Выберите ваш проект
3. Перейдите в SQL Editor
4. Скопируйте содержимое файла `database/migrations/011_EMAIL_UNIQUENESS_CHECK.sql`
5. Вставьте в SQL Editor и нажмите Run

### Вариант 2: Через Supabase CLI
```bash
supabase db push
```

## Проверка
После применения миграции:
1. Попробуйте указать email, который уже используется другим пользователем
2. Должна появиться ошибка "Этот email уже используется другим аккаунтом"

## Что делает функция
- `check_email_exists(email_to_check, current_user_id)` - проверяет, существует ли email в таблице profiles
- Исключает технические email вида `*@telegram.local`
- Исключает проверку для текущего пользователя (можно оставить свой email)
- Использует SECURITY DEFINER для обхода RLS политик

