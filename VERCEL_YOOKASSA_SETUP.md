# üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Æ–ö–∞—Å—Å–∞ –Ω–∞ Vercel

## –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Vercel

1. –û—Ç–∫—Ä–æ–π—Ç–µ [Vercel Dashboard](https://vercel.com/dashboard)
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç MargoFitness
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Settings ‚Üí Environment Variables**
4. –î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```bash
# –Æ–ö–∞—Å—Å–∞
YOOKASSA_SHOP_ID=1236232
YOOKASSA_SECRET_KEY=test_TVB8TaaAmH5opZrt-O4xicPqgoIYnUSCTIWtIG5kR4E
YOOKASSA_WEBHOOK_SECRET=your_webhook_secret_from_yookassa

# Supabase
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# Site URL
NEXT_PUBLIC_SITE_URL=https://your-domain.vercel.app
NEXT_PUBLIC_YOOKASSA_RETURN_URL=https://your-domain.vercel.app/dashboard?payment=success

# Cron
CRON_SECRET=your_random_secret_key
```

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è):

```bash
# Telegram Auth
TELEGRAM_BOT_TOKEN=your_bot_token
NEXT_PUBLIC_TELEGRAM_BOT_ID=your_bot_id
NEXT_PUBLIC_TELEGRAM_BOT_NAME=your_bot_name

# Yandex OAuth
YANDEX_CLIENT_ID=your_client_id
YANDEX_CLIENT_SECRET=your_client_secret

# Email (Resend)
RESEND_API_KEY=your_resend_api_key
EMAIL_FROM=MargoFitness <onboarding@resend.dev>
```

5. –î–ª—è –∫–∞–∂–¥–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤—ã–±–µ—Ä–∏—Ç–µ environment: **Production, Preview, Development**
6. –ù–∞–∂–º–∏—Ç–µ **Save**

---

## –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –Æ–ö–∞—Å—Å—ã

1. –û—Ç–∫—Ä–æ–π—Ç–µ [–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –Æ–ö–∞—Å—Å–∞](https://yookassa.ru/)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (Webhooks)**
3. –ù–∞–∂–º–∏—Ç–µ **–î–æ–±–∞–≤–∏—Ç—å HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ**
4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ:

### URL –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
```
https://your-domain.vercel.app/api/payments/webhook
```

### –°–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
- ‚úÖ `payment.succeeded` - –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞
- ‚úÖ `payment.canceled` - –û—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞
- ‚úÖ `refund.succeeded` - –£—Å–ø–µ—à–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç

5. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –°–µ–∫—Ä–µ—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–∏** –∏ –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ Vercel –∫–∞–∫ `YOOKASSA_WEBHOOK_SECRET`
6. –ù–∞–∂–º–∏—Ç–µ **–°–æ—Ö—Ä–∞–Ω–∏—Ç—å**

---

## –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cron Job –¥–ª—è –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è

Vercel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏—Ç cron job –∏–∑ —Ñ–∞–π–ª–∞ `vercel.json`.

–ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–π—Ç–µ `vercel.json` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```json
{
  "crons": [
    {
      "path": "/api/cron/renew-subscriptions",
      "schedule": "0 2 * * *"
    }
  ]
}
```

–≠—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 02:00 UTC.

### –ó–∞—â–∏—Ç–∞ Cron endpoint:

Endpoint —É–∂–µ –∑–∞—â–∏—â–µ–Ω –ø—Ä–æ–≤–µ—Ä–∫–æ–π `CRON_SECRET`. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:
1. `CRON_SECRET` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ Vercel Environment Variables
2. –ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–ª—É—á–∞–π–Ω–æ–µ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–æ–ª–µ–π)

---

## –®–∞–≥ 4: –î–µ–ø–ª–æ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π

1. –ó–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
```bash
git add .
git commit -m "feat: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Æ–ö–∞—Å—Å–∞ (embedded + redirect –≤–∏–¥–∂–µ—Ç—ã)"
git push origin main
```

2. Vercel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–Ω–µ—Ç –¥–µ–ø–ª–æ–π
3. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏

---

## –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í Vercel Dashboard ‚Üí Deployments ‚Üí Latest ‚Üí Logs –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ:
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã
- –ù–µ—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

### 2. –¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ (Embedded –≤–∏–¥–∂–µ—Ç)

1. –û—Ç–∫—Ä–æ–π—Ç–µ: `https://your-domain.vercel.app/pricing`
2. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ ‚Üí –ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –æ–ø–ª–∞—Ç–µ
3. –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã –≤—ã–±–µ—Ä–∏—Ç–µ **Embedded –≤–∏–¥–∂–µ—Ç**
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É –Æ–ö–∞—Å—Å—ã:
   - –ù–æ–º–µ—Ä: `5555 5555 5555 4444`
   - –°—Ä–æ–∫: –ª—é–±–∞—è –±—É–¥—É—â–∞—è –¥–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 12/25)
   - CVV: –ª—é–±—ã–µ 3 —Ü–∏—Ñ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 123)
5. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ–ø–ª–∞—Ç—É
6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∞—Å—å

### 3. –¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ (Redirect)

1. –û—Ç–∫—Ä–æ–π—Ç–µ: `https://your-domain.vercel.app/pricing`
2. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ ‚Üí –ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –æ–ø–ª–∞—Ç–µ
3. –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã –≤—ã–±–µ—Ä–∏—Ç–µ **Redirect**
4. –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Æ–ö–∞—Å—Å—ã
5. –í–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É –∏ –æ–ø–ª–∞—Ç–∏—Ç–µ
6. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤–µ—Ä–Ω–µ—Ç–µ—Å—å –Ω–∞ —Å–∞–π—Ç
7. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–∫—Ç–∏–≤–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–∫–∏

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ Webhook

–í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –Æ–ö–∞—Å—Å—ã:
1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
2. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à webhook
3. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏
4. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å—Ç–∞—Ç—É—Å: **200 OK**

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ Cron Job

–í Vercel Dashboard:
1. **Cron Jobs** (–≤ –º–µ–Ω—é —Å–ª–µ–≤–∞)
2. –ù–∞–π–¥–∏—Ç–µ `/api/cron/renew-subscriptions`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ: **0 2 * * ***
4. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø—É—Å–∫–æ–≤

–î–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```bash
curl -X GET "https://your-domain.vercel.app/api/cron/renew-subscriptions" \
  -H "Authorization: Bearer your_cron_secret"
```

---

## –®–∞–≥ 6: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –ø–ª–∞—Ç–µ–∂–µ–π

–í Supabase:
```sql
SELECT * FROM payment_transactions
ORDER BY created_at DESC
LIMIT 10;
```

### –õ–æ–≥–∏ –æ—à–∏–±–æ–∫ –≤ Vercel

1. –û—Ç–∫—Ä–æ–π—Ç–µ **Deployments ‚Üí Latest ‚Üí Runtime Logs**
2. –§–∏–ª—å—Ç—Ä: **Error**
3. –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ –≤ webhook –∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ Vercel:
1. **Settings ‚Üí Notifications**
2. –í–∫–ª—é—á–∏—Ç–µ:
   - ‚úÖ Deployment Failed
   - ‚úÖ Cron Job Failed

---

## üîß Troubleshooting

### Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –≤ –Æ–ö–∞—Å—Å–µ: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `https://`, –Ω–µ `http://`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ `YOOKASSA_WEBHOOK_SECRET` —Å–æ–≤–ø–∞–¥–∞–µ—Ç
3. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –≤ Vercel Runtime Logs
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å—Ç–æ—Ä–∏—é webhook –≤ –Æ–ö–∞—Å—Å–µ

### –ü–ª–∞—Ç–µ–∂–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `YOOKASSA_SHOP_ID` –∏ `YOOKASSA_SECRET_KEY`
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏ (–Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å `test_`)
3. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ Network –≤ DevTools: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 200 OK
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `console.error` –≤ `/api/payments/create`

### –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ Cron Job –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è (Vercel Dashboard)
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `CRON_SECRET` —Å–æ–≤–ø–∞–¥–∞–µ—Ç
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—Å—Ç—å `payment_method_id`
4. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ `/api/cron/renew-subscriptions`

### Embedded –≤–∏–¥–∂–µ—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞: –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è Content Security Policy
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ–ª—É—á–µ–Ω `confirmation_token`
4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–µ–∂–∏–º Redirect

---

## üìä Production Checklist

- [ ] –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ Vercel
- [ ] Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –Æ–ö–∞—Å—Å–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º URL
- [ ] –°–µ–∫—Ä–µ—Ç webhook (`YOOKASSA_WEBHOOK_SECRET`) —Å–æ–≤–ø–∞–¥–∞–µ—Ç
- [ ] Cron Job –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- [ ] –ü—Ä–æ–≤–µ–¥–µ–Ω —É—Å–ø–µ—à–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ (embedded)
- [ ] –ü—Ä–æ–≤–µ–¥–µ–Ω —É—Å–ø–µ—à–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ (redirect)
- [ ] Webhook –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å—Ç–∞—Ç—É—Å 200)
- [ ] –ü–æ–¥–ø–∏—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ë–î
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–±–æ—è—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

---

## üéØ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Production –∫–ª—é—á–∏

–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏:

1. –í –Æ–ö–∞—Å—Å–µ –ø–µ—Ä–µ–π–¥–∏—Ç–µ —Å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ –Ω–∞ –±–æ–µ–≤–æ–π
2. –ü–æ–ª—É—á–∏—Ç–µ –±–æ–µ–≤—ã–µ –∫–ª—é—á–∏ (–±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ `test_`)
3. –û–±–Ω–æ–≤–∏—Ç–µ –≤ Vercel:
   - `YOOKASSA_SHOP_ID` ‚Üí –±–æ–µ–≤–æ–π shop id
   - `YOOKASSA_SECRET_KEY` ‚Üí –±–æ–µ–≤–æ–π secret key
4. –û–±–Ω–æ–≤–∏—Ç–µ webhook URL –Ω–∞ –±–æ–µ–≤–æ–π
5. –û–±–Ω–æ–≤–∏—Ç–µ `YOOKASSA_WEBHOOK_SECRET`
6. –ü—Ä–æ–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ –º–∞–ª–æ–π —Å—É–º–º–æ–π

---

**–î–∞—Ç–∞:** 24 –¥–µ–∫–∞–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0.0

