# История покупок - Реализация

## Что было реализовано

### 1. Миграция БД (046_ADD_PURCHASE_DETAILS.sql)

Добавлены поля в таблицу `user_purchases`:
- `action` (ENUM: 'purchase', 'renewal', 'upgrade') - тип операции
- `promo_code` (text) - использованный промокод
- `bonus_amount_used` (integer) - количество использованных бонусных шагов
- `metadata` (jsonb) - дополнительные метаданные

Миграция также обновляет существующие записи, извлекая данные из `payment_transactions.metadata`.

**Применение миграции:**
```bash
# Через Supabase SQL Editor
# Скопируйте содержимое database/migrations/046_ADD_PURCHASE_DETAILS.sql
# Вставьте в SQL Editor и выполните
```

### 2. Server Action (lib/actions/purchase-history.ts)

Создан новый server action `getUserPurchaseHistory()` который:
- Получает историю покупок текущего пользователя
- Обогащает данные информацией из транзакций и промокодов
- Вычисляет скидки, проценты и итоговые суммы
- Возвращает структурированные данные для UI

### 3. Компонент личного кабинета (subscription-tab.tsx)

Обновлен блок "История покупок" с функциональностью:

**Основные возможности:**
- Отображение реальных данных вместо мок-данных
- Разделение операций по категориям (покупка/продление/апгрейд)
- Аккордеон для каждой покупки с детальной информацией

**Детальная информация при раскрытии:**
- Использованный промокод и процент скидки
- Количество использованных бонусных шагов
- Скидка за период подписки
- Период подписки в днях/месяцах
- Сводка с разбивкой всех скидок

**Визуальное оформление:**
- Иконки для разных типов операций (покупка/продление/апгрейд)
- Цветовая кодировка тарифов (Basic/Pro/Elite)
- Анимированные раскрывающиеся панели
- Адаптивный дизайн

### 4. Админка

Функционал истории покупок в админке остался без изменений и продолжает корректно работать с существующей логикой обогащения данных в `admin-user-details.ts`.

## Структура данных

### PurchaseHistoryItem
```typescript
{
  id: string
  product_name: string
  tier: 'Basic' | 'Pro' | 'Elite'
  action: 'purchase' | 'renewal' | 'upgrade'
  created_at: string
  actual_paid_amount: number
  base_price: number
  promo_code?: string
  promo_percent?: number
  promo_discount_amount?: number
  bonus_amount_used?: number
  bonus_percent_of_total?: number
  period_discount?: number
  purchased_days?: number
  payment_provider?: string
}
```

## Единая логика

Обогащение данных истории покупок теперь работает единообразно:
1. **Админка** - использует `admin-user-details.ts` (существующая логика)
2. **Личный кабинет** - использует `purchase-history.ts` (новая логика)

Оба варианта:
- Извлекают данные из `user_purchases`
- Обогащают данными из `payment_transactions.metadata`
- Получают информацию о промокодах из `promo_codes`
- Вычисляют скидки и проценты одинаковым образом

## Обновление существующих данных

Миграция автоматически обновит существующие записи покупок, извлекая данные из метаданных транзакций. Для покупок без связанных транзакций будут установлены значения по умолчанию:
- `action = 'purchase'`
- `bonus_amount_used = 0`
- `promo_code = NULL`

## Тестирование

После применения миграции проверьте:

1. **Админка** - История покупок в карточке пользователя:
   - Открыть любого пользователя с покупками
   - Проверить вкладку "Покупки"
   - Убедиться, что категории (покупка/продление/апгрейд) отображаются корректно

2. **Личный кабинет** - Вкладка "Подписка":
   - Войти под пользователем с покупками
   - Перейти на вкладку "Подписка"
   - Проверить блок "История покупок"
   - Раскрыть аккордеон и проверить детальную информацию

3. **Новые покупки**:
   - Совершить тестовую покупку с промокодом
   - Совершить тестовую покупку с использованием бонусов
   - Проверить, что все данные корректно сохраняются и отображаются

## UX улучшения

Добавлены следующие улучшения для пользовательского опыта:

1. **Визуальная дифференциация**:
   - Иконки и метки для типов операций
   - Цветовая кодировка тарифов
   - Индикаторы скидок

2. **Информативность**:
   - Детальная разбивка стоимости
   - Показ всех примененных скидок
   - Информация о сроке подписки

3. **Удобство**:
   - Раскрывающиеся панели для экономии места
   - Состояние загрузки
   - Пустое состояние для новых пользователей

## Расширение в будущем

Легко добавить:
- Фильтрацию по типу операции
- Поиск по дате
- Экспорт истории в CSV/PDF
- Дополнительные детали (метод оплаты, ID транзакции и т.д.)
