# ğŸ”„ Telegram Auth - Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ°

## Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     TELEGRAM ĞĞ’Ğ¢ĞĞ Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ â”‚
â”‚  Ğ½Ğ° /login   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Ğ’Ğ¸Ğ´Ğ¸Ñ‚ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "Telegram"
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OAuth Buttons    â”‚
â”‚ [Google]         â”‚
â”‚ [Yandex]         â”‚
â”‚ [VK]             â”‚
â”‚ [Telegram] â—„â”€â”€â”€â”€ ĞšĞ»Ğ¸Ğº
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. setShowTelegramWidget(true)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TelegramLoginWidget         â”‚
â”‚                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Log in with Telegram    â”‚ â”‚ â—„â”€â”€ ĞÑ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ğ¸Ğ´Ğ¶ĞµÑ‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     Ğ¾Ñ‚ Telegram
â”‚                             â”‚
â”‚      [ĞÑ‚Ğ¼ĞµĞ½Ğ°]               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ĞºĞ»Ğ¸ĞºĞ°ĞµÑ‚ Ğ½Ğ° Ğ²Ğ¸Ğ´Ğ¶ĞµÑ‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram Server    â”‚
â”‚  (telegram.org)     â”‚
â”‚                     â”‚
â”‚  ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°:          â”‚
â”‚  - ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½?     â”‚
â”‚  - Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ?       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. Callback Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
       â”‚    {
       â”‚      id: 123456789,
       â”‚      first_name: "Ğ˜Ğ²Ğ°Ğ½",
       â”‚      username: "ivan",
       â”‚      photo_url: "...",
       â”‚      auth_date: 1703419200,
       â”‚      hash: "abc123..."
       â”‚    }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ window.onTelegramAuth()     â”‚
â”‚ (Frontend callback)         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 5. POST /api/auth/telegram
       â”‚    Body: TelegramUser data
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /api/auth/telegram/route.ts            â”‚
â”‚                                         â”‚
â”‚ âœ“ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° hash (HMAC-SHA256)          â”‚
â”‚ âœ“ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° timestamp (< 24 Ñ‡Ğ°ÑĞ°)       â”‚
â”‚ âœ“ ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ telegram_id    â”‚
â”‚                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚   â”‚ Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚? â”‚                      â”‚
â”‚   â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜                      â”‚
â”‚      â”‚      â”‚                           â”‚
â”‚     Ğ”Ğ     ĞĞ•Ğ¢                          â”‚
â”‚      â”‚      â”‚                           â”‚
â”‚      â”‚      â””â”€â”€â–º Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ:               â”‚
â”‚      â”‚           - auth.users           â”‚
â”‚      â”‚           - profiles             â”‚
â”‚      â”‚           - telegram_id          â”‚
â”‚      â”‚                                  â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â–º ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ:                 â”‚
â”‚               - full_name               â”‚
â”‚               - avatar_url              â”‚
â”‚               - telegram_username       â”‚
â”‚                                         â”‚
â”‚ âœ“ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ exchange code              â”‚
â”‚ âœ“ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² auth_exchange_codes     â”‚
â”‚   (expires_at: NOW + 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚)          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 6. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ { exchangeCode: "abc..." }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ĞºĞ¾Ğ´       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 7. POST /api/auth/telegram/exchange
       â”‚    Body: { exchangeCode }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /api/auth/telegram/exchange/route.ts   â”‚
â”‚                                         â”‚
â”‚ âœ“ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ´Ğ° Ğ² Ğ‘Ğ”                   â”‚
â”‚ âœ“ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° used = false                â”‚
â”‚ âœ“ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° expires_at > NOW            â”‚
â”‚ âœ“ ĞŸĞ¾Ğ¼ĞµÑ‚ĞºĞ° used = true                  â”‚
â”‚ âœ“ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ magic link                 â”‚
â”‚   (supabase.auth.admin.generateLink)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 8. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ { actionLink: "..." }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚           â”‚
â”‚ window.location.href =      â”‚
â”‚   actionLink                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 9. Supabase ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ ÑĞµÑÑĞ¸Ñ
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚ Ğ½Ğ° /dashboard      â”‚
â”‚                             â”‚
â”‚ âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ ÑÑ‚Ğ°Ğ¿Ğµ

### Ğ­Ñ‚Ğ°Ğ¿ 1-3: Frontend
```
âœ“ ĞÑ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ğ¸Ğ´Ğ¶ĞµÑ‚ Ğ¾Ñ‚ Telegram
âœ“ HTTPS Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½ (ĞºÑ€Ğ¾Ğ¼Ğµ localhost)
âœ“ Ğ”Ğ¾Ğ¼ĞµĞ½ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ñƒ BotFather
```

### Ğ­Ñ‚Ğ°Ğ¿ 4: Telegram Callback
```
âœ“ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ Telegram (hash)
âœ“ ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ´Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ±ĞµĞ· Bot Token
âœ“ Timestamp Ğ´Ğ»Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹ Ğ¾Ñ‚ replay Ğ°Ñ‚Ğ°Ğº
```

### Ğ­Ñ‚Ğ°Ğ¿ 5: Backend Verification
```typescript
// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸
const secretKey = crypto
  .createHash('sha256')
  .update(TELEGRAM_BOT_TOKEN)
  .digest()

const computedHash = crypto
  .createHmac('sha256', secretKey)
  .update(dataCheckString)
  .digest('hex')

if (computedHash !== receivedHash) {
  throw new Error('Invalid hash')
}

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
if (currentTime - auth_date > 86400) {
  throw new Error('Data expired')
}
```

### Ğ­Ñ‚Ğ°Ğ¿ 6-7: Exchange Code
```
âœ“ ĞĞ´Ğ½Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ´ (32 Ğ±Ğ°Ğ¹Ñ‚Ğ° random)
âœ“ Ğ¥Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑÑ Ğ² Ğ‘Ğ” Ñ Ñ„Ğ»Ğ°Ğ³Ğ¾Ğ¼ used
âœ“ Ğ˜ÑÑ‚ĞµĞºĞ°ĞµÑ‚ Ñ‡ĞµÑ€ĞµĞ· 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
âœ“ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ·
```

### Ğ­Ñ‚Ğ°Ğ¿ 8-9: Session Creation
```
âœ“ Magic link Ğ¾Ñ‚ Supabase
âœ“ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸
âœ“ Secure cookie Ñ JWT
âœ“ RLS Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
```

---

## ğŸ“Š Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### auth_exchange_codes
```sql
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id          â”‚ UUID (PK)              â”‚
â”‚ code        â”‚ TEXT (UNIQUE)          â”‚
â”‚ user_id     â”‚ UUID (FK â†’ auth.users) â”‚
â”‚ expires_at  â”‚ TIMESTAMPTZ            â”‚
â”‚ used        â”‚ BOOLEAN (default false)â”‚
â”‚ created_at  â”‚ TIMESTAMPTZ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹:
- idx_auth_exchange_codes_code
- idx_auth_exchange_codes_user_id
- idx_auth_exchange_codes_expires_at
```

### profiles (Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ)
```sql
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ telegram_id       â”‚ TEXT (UNIQUE)    â”‚
â”‚ telegram_username â”‚ TEXT             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ğ˜Ğ½Ğ´ĞµĞºÑ:
- idx_profiles_telegram_id
```

---

## â±ï¸ Ğ¢Ğ°Ğ¹Ğ¼Ğ»Ğ°Ğ¹Ğ½ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

```
0ms     â”‚ ĞšĞ»Ğ¸Ğº Ğ½Ğ° "Telegram"
        â”‚
100ms   â”‚ ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ²Ğ¸Ğ´Ğ¶ĞµÑ‚Ğ°
        â”‚
500ms   â”‚ ĞšĞ»Ğ¸Ğº Ğ½Ğ° "Log in with Telegram"
        â”‚
1000ms  â”‚ Ğ ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚ Ğ½Ğ° Telegram
        â”‚
2000ms  â”‚ ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ² Telegram
        â”‚
2500ms  â”‚ Callback Ğ½Ğ° ÑĞ°Ğ¹Ñ‚
        â”‚
2600ms  â”‚ POST /api/auth/telegram
        â”‚
2700ms  â”‚ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° hash + ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ/Ğ¿Ğ¾Ğ¸ÑĞº user
        â”‚
2800ms  â”‚ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ exchange code
        â”‚
2900ms  â”‚ POST /api/auth/telegram/exchange
        â”‚
3000ms  â”‚ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ magic link
        â”‚
3100ms  â”‚ Ğ ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚ Ğ½Ğ° dashboard
        â”‚
3200ms  â”‚ âœ… ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½!
```

**ĞĞ±Ñ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ:** ~3 ÑĞµĞºÑƒĞ½Ğ´Ñ‹ Ğ¾Ñ‚ ĞºĞ»Ğ¸ĞºĞ° Ğ´Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

---

## ğŸ”„ ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ°Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ â”‚
â”‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ ĞšĞ»Ğ¸Ğº "Telegram"
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Telegram callback   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ POST /api/auth/telegram
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ telegram_id        â”‚
â”‚                             â”‚
â”‚ âœ“ ĞĞ°Ğ¹Ğ´ĞµĞ½!                   â”‚
â”‚ âœ“ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:        â”‚
â”‚   - full_name (ĞµÑĞ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½)â”‚
â”‚   - avatar_url (ĞµÑĞ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½â”‚
â”‚   - telegram_username       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Exchange code
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Ğ’Ñ…Ğ¾Ğ´ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ’Ñ€ĞµĞ¼Ñ:** ~2 ÑĞµĞºÑƒĞ½Ğ´Ñ‹ (Ğ±Ñ‹ÑÑ‚Ñ€ĞµĞµ, Ñ‚.Ğº. Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ)

---

## ğŸ¯ Ğ¢Ğ¾Ñ‡ĞºĞ¸ Ğ¾Ñ‚ĞºĞ°Ğ·Ğ° Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº

### 1. Widget Ğ½Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ğ»ÑÑ
```typescript
// Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ 10 ÑĞµĞºÑƒĞ½Ğ´
setTimeout(() => {
  if (!widgetLoaded) {
    setError('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Telegram Ğ²Ğ¸Ğ´Ğ¶ĞµÑ‚')
  }
}, 10000)
```

### 2. Invalid hash
```typescript
if (!verifyTelegramAuth(data, botToken)) {
  return NextResponse.json(
    { error: 'Invalid authentication data' },
    { status: 401 }
  )
}
```

### 3. Expired data
```typescript
if (currentTime - auth_date > 86400) {
  return NextResponse.json(
    { error: 'Authentication data expired' },
    { status: 401 }
  )
}
```

### 4. Exchange code expired
```typescript
if (expiresAt < new Date()) {
  return NextResponse.json(
    { error: 'Exchange code expired' },
    { status: 401 }
  )
}
```

### 5. Database error
```typescript
try {
  await supabase.from('profiles').insert(...)
} catch (error) {
  console.error('[Telegram Auth] DB error:', error)
  // ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ, Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ ÑĞ¾Ğ·Ğ´Ğ°ÑÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· trigger
}
```

---

## ğŸ“ˆ ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¸ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³

### Ğ›Ğ¾Ğ³Ğ¸ Frontend
```javascript
console.log('[Telegram Widget] Auth callback received')
console.log('[Telegram Widget] Sending to backend')
console.log('[Telegram Widget] Exchange code received')
console.log('[Telegram Widget] Session created')
```

### Ğ›Ğ¾Ğ³Ğ¸ Backend
```javascript
console.log('[Telegram Auth] Received data:', { id, username })
console.log('[Telegram Auth] Hash verified')
console.log('[Telegram Auth] User found/created:', userId)
console.log('[Telegram Auth] Exchange code generated')
console.log('[Telegram Exchange] Code verified')
console.log('[Telegram Exchange] Session created')
```

### ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ
- ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¹ Ñ‡ĞµÑ€ĞµĞ· Telegram
- ĞĞ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ vs ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ
- Ğ’Ñ€ĞµĞ¼Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ (ÑÑ€ĞµĞ´Ğ½ĞµĞµ)
- ĞÑˆĞ¸Ğ±ĞºĞ¸ hash verification
- Ğ˜ÑÑ‚ĞµĞºÑˆĞ¸Ğµ exchange codes
- ĞĞµÑƒĞ´Ğ°Ñ‡Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸

---

## âœ… ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ° Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹

âœ… **Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ** - Ğ¼Ğ½Ğ¾Ğ³Ğ¾ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ²Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°  
âœ… **Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ** - ~3 ÑĞµĞºÑƒĞ½Ğ´Ñ‹ Ğ´Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸  
âœ… **ĞĞ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚ÑŒ** - Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ğ¸Ğ´Ğ¶ĞµÑ‚ Telegram  
âœ… **ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾ÑÑ‚ÑŒ** - stateless exchange codes  
âœ… **Ğ£Ğ´Ğ¾Ğ±ÑÑ‚Ğ²Ğ¾** - 1 ĞºĞ»Ğ¸Ğº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ  
âœ… **Ğ“Ğ¸Ğ±ĞºĞ¾ÑÑ‚ÑŒ** - Ğ»ĞµĞ³ĞºĞ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ñ‹  

---

**Ğ”Ğ°Ñ‚Ğ°:** 24 Ğ´ĞµĞºĞ°Ğ±Ñ€Ñ 2025  
**Ğ’ĞµÑ€ÑĞ¸Ñ:** 1.0.0

