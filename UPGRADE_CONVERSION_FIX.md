# Исправление расчета конвертации при апгрейде подписки

## Проблема

При апгрейде подписки количество бонусных дней от неиспользованной части текущей подписки **менялось в зависимости от срока новой подписки**, что было неправильно.

### Пример проблемы (ДО исправления)

Пользователь с остатком Pro подписки в 30 дней (стоимость остатка ~4499₽) апгрейдится на Elite:

- **1 месяц Elite** (5399₽): бонус = 4499 / (5399/30) = **~25 дней**
- **3 месяца Elite** (15385₽ с -5%): бонус = 4499 / (15385/90) = **~26 дней**
- **6 месяцев Elite** (29214₽ с -10%): бонус = 4499 / (29214/180) = **~27 дней**
- **12 месяцев Elite** (55081₽ с -15%): бонус = 4499 / (55081/360) = **~29 дней**

**Проблема**: Одинаковый остаток старой подписки давал разное количество бонусных дней!

## Причина

В функции `calculateUpgradeConversion` для расчета цены дня новой подписки использовалась **цена выбранного срока со скидкой**:

```typescript
const newDayPrice = newPrice / newTotalDays
```

Из-за скидок за срок (3 мес: -5%, 6 мес: -10%, 12 мес: -15%) цена дня получалась разной.

## Решение

Используем **базовую месячную цену** (без скидки за срок) для расчета конвертации:

```typescript
const newDayPrice = newBaseMonthlyPrice / 30
```

Где `newBaseMonthlyPrice` - это цена тарифа на 1 месяц (например, Elite 1 месяц = 5399₽).

### Результат (ПОСЛЕ исправления)

Теперь при том же остатке Pro подписки в 30 дней:

- **1 месяц Elite**: бонус = 4499 / (5399/30) = **~25 дней**
- **3 месяца Elite**: бонус = 4499 / (5399/30) = **~25 дней**
- **6 месяцев Elite**: бонус = 4499 / (5399/30) = **~25 дней**
- **12 месяцев Elite**: бонус = 4499 / (5399/30) = **~25 дней**

✅ **Количество бонусных дней теперь одинаковое!**

## Измененные файлы

### 1. `lib/services/subscription-manager.ts`

**Изменения:**
- Добавлен параметр `newBaseMonthlyPrice` в функцию `calculateUpgradeConversion`
- Изменен расчет `newDayPrice`: теперь использует базовую месячную цену вместо цены со скидкой

### 2. `app/api/payments/calculate-upgrade/route.ts`

**Изменения:**
- Добавлен запрос для получения базовой месячной цены нового тарифа
- Передача `newBaseMonthlyPrice` в функцию `calculateUpgradeConversion`

### 3. `app/api/payments/create/route.ts`

**Изменения:**
- Добавлен запрос для получения базовой месячной цены нового тарифа при апгрейде
- Передача `newBaseMonthlyPrice` в функцию `calculateUpgradeConversion`

### 4. `app/api/payments/upgrade/route.ts`

**Изменения:**
- Добавлен запрос для получения базовой месячной цены нового тарифа
- Передача `newBaseMonthlyPrice` в функцию `calculateUpgradeConversion`

## Тестирование

### Проверка корректности

1. Создайте тестовую подписку Pro на 1 месяц
2. Подождите несколько дней (например, останется 20 дней)
3. Попробуйте апгрейдиться на Elite с разными сроками:
   - 1 месяц
   - 3 месяца
   - 6 месяцев
   - 12 месяцев
4. **Ожидаемый результат**: Количество бонусных дней должно быть **одинаковым** для всех сроков

### Формула расчета

```typescript
// Стоимость остатка старой подписки
remainderValue = remainingDays × (currentPrice / (currentDurationMonths × 30))

// Цена дня нового тарифа (базовая, без скидки)
newDayPrice = baseMonthlyPrice / 30

// Конвертированные дни
convertedDays = floor(remainderValue / newDayPrice)
```

## Требования к БД

В таблице `products` должны быть созданы продукты на **1 месяц** для каждого тарифа:

- Basic 1 месяц (tier_level = 1, duration_months = 1)
- Pro 1 месяц (tier_level = 2, duration_months = 1)
- Elite 1 месяц (tier_level = 3, duration_months = 1)

✅ Эти продукты уже созданы в миграции `008_ADD_YOOKASSA_INTEGRATION.sql`

## Деплой

1. Коммит изменений:
```bash
git add .
git commit -m "fix: correct upgrade bonus days calculation"
```

2. Push в GitHub:
```bash
git push origin main
```

3. Vercel автоматически задеплоит изменения

## Обратная совместимость

✅ Изменения **полностью обратно совместимы**:
- Не требуется миграция БД
- Не меняется API контракт
- Существующие подписки не затрагиваются
- Новые апгрейды сразу используют правильную логику

---

**Дата исправления**: 26 декабря 2024  
**Автор**: AI Assistant

