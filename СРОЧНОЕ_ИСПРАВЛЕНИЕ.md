# üö® –°–†–û–ß–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï OAUTH

## ‚ùó –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞–π–¥–µ–Ω–∞!

–í –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞ –≤–∏–¥–Ω–∞ –æ—à–∏–±–∫–∞:
```
error_description=Database+error+saving+new+user
```

**–≠—Ç–æ –∑–Ω–∞—á–∏—Ç:** –¢—Ä–∏–≥–≥–µ—Ä –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï (3 –º–∏–Ω—É—Ç—ã)

### –®–ê–ì 1: –û—Ç–∫—Ä–æ–π—Ç–µ Supabase SQL Editor

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç –≤ Supabase Dashboard
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **SQL Editor** (—Å–ª–µ–≤–∞ –≤ –º–µ–Ω—é)
3. –ù–∞–∂–º–∏—Ç–µ **New query**

### –®–ê–ì 2: –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ SQL

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `database/FIX_OAUTH_TRIGGER.sql` –≤ –ø—Ä–æ–µ–∫—Ç–µ –∏ **—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –∫–æ–¥**.

–ò–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –æ—Ç—Å—é–¥–∞:

```sql
-- –£–î–ê–õ–Ø–ï–ú –°–¢–ê–†–´–ô –¢–†–ò–ì–ì–ï–†
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
DROP FUNCTION IF EXISTS handle_new_user();

-- –°–û–ó–î–ê–ï–ú –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER 
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  INSERT INTO public.profiles (
    id, 
    email, 
    role, 
    subscription_status, 
    subscription_tier
  )
  VALUES (
    NEW.id,
    NEW.email,
    CASE 
      WHEN NEW.email = 'loki2723@mail.ru' THEN 'admin'
      ELSE 'user' 
    END,
    'inactive',
    'free'
  )
  ON CONFLICT (id) DO NOTHING;
  
  RETURN NEW;
EXCEPTION
  WHEN OTHERS THEN
    RAISE WARNING 'Failed to create profile for user %: %', NEW.id, SQLERRM;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- –°–û–ó–î–ê–ï–ú –¢–†–ò–ì–ì–ï–†
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION handle_new_user();

-- –°–û–ó–î–ê–ï–ú –ü–†–û–§–ò–õ–ò –î–õ–Ø –°–£–©–ï–°–¢–í–£–Æ–©–ò–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
INSERT INTO public.profiles (id, email, role, subscription_status, subscription_tier)
SELECT 
  au.id,
  au.email,
  CASE 
    WHEN au.email = 'loki2723@mail.ru' THEN 'admin'
    ELSE 'user' 
  END,
  'inactive',
  'free'
FROM auth.users au
LEFT JOIN public.profiles p ON au.id = p.id
WHERE p.id IS NULL
ON CONFLICT (id) DO NOTHING;
```

### –®–ê–ì 3: –ù–∞–∂–º–∏—Ç–µ RUN (–∏–ª–∏ Ctrl+Enter)

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
‚úÖ Success. No rows returned
```

### –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å:

```sql
-- –ü–†–û–í–ï–†–ö–ê
SELECT 
  '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ auth.users' as "–ú–µ—Ç—Ä–∏–∫–∞",
  COUNT(*) as "–ó–Ω–∞—á–µ–Ω–∏–µ"
FROM auth.users
UNION ALL
SELECT 
  '–ü—Ä–æ—Ñ–∏–ª–µ–π –≤ profiles',
  COUNT(*)
FROM public.profiles
UNION ALL
SELECT 
  '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ë–ï–ó –ø—Ä–æ—Ñ–∏–ª—è',
  COUNT(*)
FROM auth.users au
LEFT JOIN public.profiles p ON au.id = p.id
WHERE p.id IS NULL;
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:** "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ë–ï–ó –ø—Ä–æ—Ñ–∏–ª—è" = **0**

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### 1. –û—á–∏—Å—Ç–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ –ø–æ–ø—ã—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞, —É–¥–∞–ª–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

```sql
-- –£–î–ê–õ–ï–ù–ò–ï –¢–ï–°–¢–û–í–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô (–û–°–¢–û–†–û–ñ–ù–û!)
-- –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–≤–µ—Ä–µ–Ω—ã:

-- DELETE FROM auth.users WHERE email LIKE '%test%';
-- DELETE FROM public.profiles WHERE email LIKE '%test%';
```

### 2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google —Å–Ω–æ–≤–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ **–∏–Ω–∫–æ–≥–Ω–∏—Ç–æ** (Ctrl+Shift+N)
2. –û—Ç–∫—Ä–æ–π—Ç–µ **–∫–æ–Ω—Å–æ–ª—å** (F12 ‚Üí Console)
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ `http://localhost:3000/auth/login`
4. –ù–∞–∂–º–∏—Ç–µ **Google**
5. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å

### 3. –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏

**–í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
[Callback] Received callback with code: YES
[Callback] Session created for user: ...
[Callback] Profile check: NOT FOUND
[Callback] Profile created successfully: ...
[Callback] Redirecting to: /dashboard
```

**–í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ Next.js –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
‚ùå error_description=Database+error+saving+new+user
```

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

```sql
SELECT * FROM auth.users ORDER BY created_at DESC LIMIT 1;
SELECT * FROM public.profiles ORDER BY created_at DESC LIMIT 1;
```

–î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏!

---

## üéØ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ?

### –ü—Ä–æ–±–ª–µ–º–∞
–°—Ç–∞—Ä—ã–π —Ç—Ä–∏–≥–≥–µ—Ä `handle_new_user()` –Ω–µ –∏–º–µ–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∏ –º–æ–≥ –ø–∞–¥–∞—Ç—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è.

### –†–µ—à–µ–Ω–∏–µ
1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `SECURITY DEFINER` - —Ç—Ä–∏–≥–≥–µ—Ä –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∞–º–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `SET search_path = public` - —è–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ —Å—Ö–µ–º—ã
3. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `ON CONFLICT DO NOTHING` - –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ `EXCEPTION` - –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
5. ‚úÖ –°–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üìã –ß–µ–∫–ª–∏—Å—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```
[ ] SQL —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ Supabase SQL Editor
[ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫–∞–∑–∞–ª–∞ 0 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –ø—Ä–æ—Ñ–∏–ª—è
[ ] –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
[ ] –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –µ—Å—Ç—å –ª–æ–≥–∏ [Callback]
[ ] –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /dashboard —Ä–∞–±–æ—Ç–∞–µ—Ç
[ ] –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –Ω–µ—Ç –æ—à–∏–±–∫–∏ "Database error saving new user"
```

---

## ‚ùì –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ü—Ä–∏—à–ª–∏—Ç–µ –º–Ω–µ:

1. ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL —Å–∫—Ä–∏–ø—Ç–∞ (—Å–∫—Ä–∏–Ω—à–æ—Ç)
2. ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –ø—Ä–æ—Ñ–∏–ª—è)
3. ‚úÖ –õ–æ–≥–∏ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –ø–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞
4. ‚úÖ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫ –∏–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ Next.js

---

**–í—ã–ø–æ–ª–Ω–∏—Ç–µ –®–ê–ì 1-4 –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞!** üöÄ

