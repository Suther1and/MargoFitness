# Исправление реферальной системы

## Проблема
Реферальная система не работала: при регистрации нового пользователя по реферальной ссылке бонусы не начислялись.

## Найденные проблемы

### 1. **OAuth авторизация не передавала реферальный код**
- При использовании Google, Yandex, Telegram OAuth реферальный код из URL не передавался в callback
- Компонент `OAuthButtons` не получал и не передавал параметр `ref` из URL

### 2. **Yandex OAuth**
- Не сохранял реферальный код в `state` параметре
- Callback не обрабатывал реферальный код для новых пользователей
- Отсутствовала проверка и создание бонусного аккаунта

### 3. **Telegram OAuth**
- Виджет Telegram не поддерживает передачу дополнительных параметров
- Отсутствовала логика передачи реферального кода в API
- Callback не обрабатывал реферальный код

### 4. **Google OAuth**
- Не передавал реферальный код в redirectTo URL

## Исправления

### 1. **components/oauth-buttons.tsx**
- ✅ Добавлен параметр `referralCode` в props компонента
- ✅ Google OAuth: реферальный код передается в `redirectTo` URL
- ✅ Yandex OAuth: реферальный код передается через query параметр
- ✅ Telegram: реферальный код передается через `redirectTo`

### 2. **app/auth/page.tsx**
- ✅ `OAuthSection` теперь извлекает `ref` параметр из URL
- ✅ Передает `referralCode` в компонент `OAuthButtons`

### 3. **app/api/auth/yandex/init/route.ts**
- ✅ Извлекает реферальный код из query параметров
- ✅ Сохраняет `ref` в `state` параметре для передачи в callback
- ✅ Добавлено логирование для отладки

### 4. **app/api/auth/yandex/callback/route.ts**
- ✅ Импортированы функции `registerReferral` и `ensureBonusAccountExists`
- ✅ Извлекает реферальный код из `state` параметра
- ✅ Для существующих пользователей проверяет наличие бонусного аккаунта
- ✅ Для новых пользователей:
  - Создает бонусный аккаунт через `ensureBonusAccountExists`
  - Регистрирует реферала через `registerReferral`
  - Начисляет бонус 250 шагов за регистрацию по приглашению
- ✅ Добавлено подробное логирование для отладки

### 5. **components/telegram-login-widget.tsx**
- ✅ Добавлена логика сохранения реферального кода в `localStorage` перед авторизацией
- ✅ Реферальный код извлекается из `redirectTo` параметра
- ✅ При авторизации код передается в API через `ref_code` поле
- ✅ После успешной авторизации код удаляется из `localStorage`

### 6. **app/api/auth/telegram/route.ts**
- ✅ Импортированы функции `registerReferral` и `ensureBonusAccountExists`
- ✅ Добавлено поле `ref_code` в интерфейс `TelegramAuthData`
- ✅ Для существующих пользователей проверяет наличие бонусного аккаунта
- ✅ Для новых пользователей:
  - Создает бонусный аккаунт через `ensureBonusAccountExists`
  - Регистрирует реферала через `registerReferral`
  - Начисляет бонус 250 шагов за регистрацию по приглашению
- ✅ Добавлено подробное логирование

## Как это работает теперь

### Сценарий 1: Email/Password регистрация
1. Пользователь переходит по ссылке `https://site.com/auth?ref=ABC123`
2. Вводит email и пароль
3. При регистрации `ref=ABC123` передается в `auth/callback`
4. Callback создает профиль, бонусный аккаунт и регистрирует реферала
5. Новый пользователь получает **250 шагов** за регистрацию по приглашению

### Сценарий 2: Google OAuth
1. Пользователь переходит по ссылке `https://site.com/auth?ref=ABC123`
2. Нажимает "Google"
3. Реферальный код передается в `redirectTo`: `/auth/callback?redirect=/dashboard&ref=ABC123`
4. После авторизации Google, callback обрабатывает реферала
5. Новый пользователь получает **250 шагов**

### Сценарий 3: Yandex OAuth
1. Пользователь переходит по ссылке `https://site.com/auth?ref=ABC123`
2. Нажимает "Yandex"
3. Реферальный код сохраняется в `state`: `{"redirect":"/dashboard","ref":"ABC123"}`
4. После авторизации Yandex, callback извлекает код из `state`
5. Новый пользователь получает **250 шагов**

### Сценарий 4: Telegram
1. Пользователь переходит по ссылке `https://site.com/auth?ref=ABC123`
2. Нажимает "Telegram"
3. Реферальный код сохраняется в `localStorage`
4. После авторизации Telegram, виджет передает код в API
5. Новый пользователь получает **250 шагов**

## Бонусы в реферальной системе

### Для приглашенного (referred user):
- **250 шагов** - при регистрации по реферальной ссылке
- **250 шагов** - приветственный бонус (итого 500 шагов)

### Для приглашающего (referrer):
- **3-10%** от каждой покупки реферала (зависит от уровня)
- **500 шагов** - разовый бонус при первой покупке реферала
- Повышение уровня реферальной программы по мере роста покупок

## Тестирование

Для проверки работы системы:

1. **Получите реферальную ссылку:**
   - Войдите как существующий пользователь
   - Перейдите в `/dashboard/bonuses`
   - Скопируйте реферальную ссылку

2. **Протестируйте регистрацию:**
   - Откройте ссылку в режиме инкогнито/другом браузере
   - Зарегистрируйтесь любым способом (email, Google, Yandex, Telegram)
   - Проверьте консоль браузера на наличие логов `[Callback]` или `[Telegram Auth]`
   - Проверьте что приглашенный получил 500 шагов (250 приветственных + 250 реферальных)

3. **Проверьте базу данных:**
   ```sql
   -- Проверить создание записи в referrals
   SELECT * FROM referrals WHERE referred_id = 'новый_user_id';
   
   -- Проверить начисление бонусов
   SELECT * FROM bonus_transactions 
   WHERE user_id = 'новый_user_id' 
   AND type = 'referral_bonus';
   
   -- Проверить баланс
   SELECT balance FROM user_bonuses WHERE user_id = 'новый_user_id';
   ```

4. **Проверьте логи сервера:**
   - Все ключевые этапы логируются с префиксами
   - `[Callback]` - для email/OAuth callback
   - `[Yandex Init]` / `[Yandex Callback]` - для Yandex
   - `[Telegram Auth]` - для Telegram
   - `[registerReferral]` - для процесса регистрации реферала

## Важные замечания

1. **Бонусный аккаунт создается автоматически** при регистрации через триггер БД
2. **Функция `ensureBonusAccountExists`** - дополнительная проверка на случай сбоя триггера
3. **Реферальный код проверяется** на:
   - Существование в базе
   - Невозможность использовать свой код
   - Невозможность зарегистрироваться дважды по реферальной ссылке
4. **Логирование** помогает отследить весь процесс в консоли сервера

## Следующие шаги

Если проблемы сохраняются:

1. Проверьте логи сервера при регистрации
2. Убедитесь что триггер `on_profile_created_create_bonus` работает
3. Проверьте RLS политики для таблиц `referrals` и `bonus_transactions`
4. Проверьте что функция `create_bonus_account_for_user` доступна

