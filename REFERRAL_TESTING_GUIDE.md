# üß™ –ü–æ—à–∞–≥–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

## ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤–Ω–µ—Å–µ–Ω—ã (–∫–æ–º–º–∏—Ç 03b115e):
- –£–≤–µ–ª–∏—á–µ–Ω —Ç–∞–π–º–∞—É—Ç —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –¥–æ 3 —Å–µ–∫—É–Ω–¥
- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
- –°–æ–∑–¥–∞–Ω debug endpoint –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

## –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥

1. –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
2. –û—Ç–∫—Ä–æ–π—Ç–µ `/dashboard/bonuses`
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–∞—à—É —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
4. –ò–∑–≤–ª–µ–∫–∏—Ç–µ –∫–æ–¥ –∏–∑ —Å—Å—ã–ª–∫–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 8 —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ—Å–ª–µ `ref=`)

**–ü—Ä–∏–º–µ—Ä:**
```
https://margofitness.pro/auth?ref=abc12345
–ö–æ–¥: abc12345
```

## –®–∞–≥ 2: –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞

–í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ VS Code —Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏:
```bash
npm run dev
```

–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞:
- `[Process Referral]` - email —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- `[Telegram Auth]` - telegram —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

## –®–∞–≥ 3: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –≤ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ

### Email —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –≤ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ
2. –í–≤–µ–¥–∏—Ç–µ email + –ø–∞—Ä–æ–ª—å
3. –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:**
```
[Process Referral] Request: { userId: '...', refCode: 'abc12345' }
[Process Referral] Waiting for DB triggers...
[Process Referral] Starting validation
[Process Referral] Bonus account check: { found: true, balance: 250 }
[Process Referral] Ref code validation: { found: true, referrerId: '...' }
[Process Referral] Existing check: { alreadyRegistered: false }
[Process Referral] Creating referral link: { referrer_id: '...', referred_id: '...' }
[Process Referral] Referral link created successfully
[Process Referral] Adding bonus transaction: 250
[Process Referral] Bonus transaction created
[Process Referral] Current balance: { balance: 250 }
[Process Referral] Balance updated: { oldBalance: 250, newBalance: 500 }
[Process Referral] ‚úÖ SUCCESS for user: ...
```

### Telegram —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –≤ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ
2. –ù–∞–∂–º–∏—Ç–µ "Telegram"
3. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ Telegram

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:**
```
[Telegram Auth] Request received: { id: ..., hasRefCode: true, refCode: 'abc12345' }
[Telegram Auth] Waiting for DB triggers...
[Telegram Auth] Starting referral processing
[Telegram Auth] Processing new user setup with admin client
[Telegram Auth] Processing referral code: abc12345
[Telegram Auth] Referral processed successfully
```

## –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –í –±—Ä–∞—É–∑–µ—Ä–µ (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ `/dashboard/bonuses`
2. –ë–∞–ª–∞–Ω—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **500 —à–∞–≥–æ–≤**
3. –í —Ä–∞–∑–¥–µ–ª–µ "–ò—Å—Ç–æ—Ä–∏—è" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 2 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
   - "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å" +250
   - "–ë–æ–Ω—É—Å –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é" +250

### –í Supabase (Database):

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É `referrals`
2. –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–ø–∏—Å—å:
   - `referrer_id` - ID –ø—Ä–∏–≥–ª–∞—à–∞—é—â–µ–≥–æ
   - `referred_id` - ID –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - `status` - "registered"

3. –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É `bonus_transactions`
4. –§–∏–ª—å—Ç—Ä –ø–æ `user_id` –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
5. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 2 –∑–∞–ø–∏—Å–∏ —Å —Ç–∏–ø–æ–º `welcome` –∏ `referral_bonus`

## –®–∞–≥ 5: Debug endpoint (–µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã)

–ï—Å–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–µ–∑ API:

### –ó–∞–ø—Ä–æ—Å:
```bash
POST https://margofitness.pro/api/debug/referral-check
Content-Type: application/json

{
  "refCode": "abc12345",
  "userId": "uuid-–Ω–æ–≤–æ–≥–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
}
```

### Postman/Insomnia:
1. –°–æ–∑–¥–∞–π—Ç–µ POST –∑–∞–ø—Ä–æ—Å
2. URL: `https://margofitness.pro/api/debug/referral-check`
3. Body (JSON):
```json
{
  "refCode": "abc12345",
  "userId": "c374c57f-5521-466b-b0b4-f0316c89d574"
}
```

### –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
```json
{
  "success": true,
  "hasServiceKey": true,
  "checks": {
    "refCodeExists": true,
    "refCodeOwner": "uuid-–ø—Ä–∏–≥–ª–∞—à–∞—é—â–µ–≥–æ",
    "bonusAccountExists": true,
    "bonusBalance": 500,
    "referralExists": true,
    "transactionsCount": 2,
    "transactions": [
      {
        "type": "referral_bonus",
        "amount": 250,
        "description": "–ë–æ–Ω—É—Å –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é"
      },
      {
        "type": "welcome",
        "amount": 250,
        "description": "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å"
      }
    ]
  }
}
```

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è:

### ‚ùå `hasServiceKey: false`
**–ü—Ä–æ–±–ª–µ–º–∞:** SERVICE_ROLE_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞

### ‚ùå `bonusAccountExists: false`
**–ü—Ä–æ–±–ª–µ–º–∞:** –¢—Ä–∏–≥–≥–µ—Ä –Ω–µ —Å–æ–∑–¥–∞–ª –±–æ–Ω—É—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Supabase, —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä `on_profile_created_create_bonus` –∞–∫—Ç–∏–≤–µ–Ω

### ‚ùå `refCodeExists: false`
**–ü—Ä–æ–±–ª–µ–º–∞:** –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
**–†–µ—à–µ–Ω–∏–µ:** –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥ –∏–∑ `/dashboard/bonuses`

### ‚ùå `referralExists: true` –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–æ–≤—ã–π email/telegram –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚ùå `bonusBalance: 250` –≤–º–µ—Å—Ç–æ 500
**–ü—Ä–æ–±–ª–µ–º–∞:** –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å –Ω–µ –Ω–∞—á–∏—Å–ª–µ–Ω
**–†–µ—à–µ–Ω–∏–µ:** 
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ `[Process Referral]`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∫–æ–¥ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è: `refCode: 'abc12345'` (–Ω–µ `'NONE'`)
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ debug endpoint –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç:

- [ ] SERVICE_ROLE_KEY –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ `.env.local`
- [ ] SERVICE_ROLE_KEY –¥–æ–±–∞–≤–ª–µ–Ω –≤ Vercel
- [ ] –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞
- [ ] –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] –û—Ç–∫—Ä—ã—Ç–æ –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –Ω–æ–≤—ã–π email/telegram (–Ω–µ —Ä–∞–Ω–µ–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç `[Process Referral]` –∏–ª–∏ `[Telegram Auth]`
- [ ] –ë–∞–ª–∞–Ω—Å = 500 —à–∞–≥–æ–≤
- [ ] –¢–∞–±–ª–∏—Ü–∞ `referrals` —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø–∏—Å—å
- [ ] 2 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ `bonus_transactions`

## –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞:

–£–¥–∞–ª–∏—Ç–µ debug endpoint –∏–∑ production (–ø–æ –∂–µ–ª–∞–Ω–∏—é):
```bash
rm app/api/debug/referral-check/route.ts
git add .
git commit -m "chore: remove debug endpoint"
git push
```

---

**–°—Ç–∞—Ç—É—Å:** üîß READY FOR TESTING
**–í—Ä–µ–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** 5 –º–∏–Ω—É—Ç
**–ù–µ–æ–±—Ö–æ–¥–∏–º–æ:** –†–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ + –∫–æ–Ω—Å–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞

