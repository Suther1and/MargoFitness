# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cron Job –¥–ª—è –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

Cron job `/api/cron/renew-subscriptions` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 02:00 UTC.

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ Vercel

### 1. –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á

–í Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables –¥–æ–±–∞–≤—å—Ç–µ:

```
CRON_SECRET = –≤–∞—à_—Å–ª—É—á–∞–π–Ω—ã–π_—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–∫–ª—é—á
```

**–ö–∞–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å:**
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 2. Vercel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç cron

–§–∞–π–ª `vercel.json` —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω:
```json
{
  "crons": [
    {
      "path": "/api/cron/renew-subscriptions",
      "schedule": "0 2 * * *"
    }
  ]
}
```

**Schedule:** `0 2 * * *` = –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 02:00 UTC (05:00 –ú–°–ö)

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –≤ Vercel:
1. –û—Ç–∫—Ä–æ–π—Ç–µ Vercel Dashboard ‚Üí Deployments ‚Üí Cron
2. –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
3. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—Ç–∞—Ç—É—Å: —É—Å–ø–µ—à–Ω–æ/–Ω–µ—É–¥–∞—á–Ω–æ

---

## üß™ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –í—Ä—É—á–Ω—É—é –∑–∞–ø—É—Å—Ç–∏—Ç—å cron:

```bash
# –í development —Ä–µ–∂–∏–º–µ (–±–µ–∑ —Å–µ–∫—Ä–µ—Ç–∞)
curl http://localhost:3000/api/cron/renew-subscriptions

# –í production —Ä–µ–∂–∏–º–µ (—Å —Å–µ–∫—Ä–µ—Ç–æ–º)
curl -H "Authorization: Bearer your-secret" \
  http://localhost:3000/api/cron/renew-subscriptions
```

### –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:

1. –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É —Å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º
2. –í Supabase SQL Editor —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `next_billing_date` –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:
   ```sql
   UPDATE profiles
   SET next_billing_date = NOW()::date
   WHERE id = 'user-id-here';
   ```
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ cron endpoint
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–∏–ª–∞—Å—å

---

## üìä –ß—Ç–æ –¥–µ–ª–∞–µ—Ç cron job:

1. **–ù–∞—Ö–æ–¥–∏—Ç –ø–æ–¥–ø–∏—Å–∫–∏** –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è:
   - `subscription_status = 'active'`
   - `auto_renew_enabled = true`
   - `payment_method_id` –Ω–µ –ø—É—Å—Ç–æ–π
   - `next_billing_date` = —Å–µ–≥–æ–¥–Ω—è

2. **–î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–¥–ø–∏—Å–∫–∏:**
   - –°–æ–∑–¥–∞–µ—Ç —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–π –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ –ÆKassa
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏
   - –õ–æ–≥–∏—Ä—É–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é

3. **–ü—Ä–∏ –æ—à–∏–±–∫–µ:**
   - –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç `failed_payment_attempts`
   - –ü—Ä–∏ 2 –Ω–µ—É–¥–∞—á–∞—Ö –ø–æ–¥—Ä—è–¥ ‚Üí –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –Ω–∞ Free
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (TODO)

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è

–ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ –≤ `vercel.json`:

```json
"schedule": "0 2 * * *"  // –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 02:00 UTC
"schedule": "0 */6 * * *"  // –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
"schedule": "0 0 * * 1"  // –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 00:00
```

[Cron syntax reference](https://crontab.guru/)

---

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –í Vercel Dashboard:

1. **Deployments ‚Üí Cron:** –õ–æ–≥–∏ –≤—Å–µ—Ö –∑–∞–ø—É—Å–∫–æ–≤
2. **Analytics:** –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É–¥–∞—á–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤
3. **Alerts:** –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –í –ª–æ–≥–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

```
[Cron] Processing renewal for user@example.com
[Cron] ‚úì Renewed subscription for user@example.com
[Cron] ‚úó Failed to renew for user2@example.com: Payment declined
```

---

## üö® Troubleshooting

### Cron –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ `vercel.json` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ deployment logs –≤ Vercel
3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `CRON_SECRET` –¥–æ–±–∞–≤–ª–µ–Ω –≤ Environment Variables

### –û—à–∏–±–∫–∞ "Unauthorized":

- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `CRON_SECRET` —Å–æ–≤–ø–∞–¥–∞–µ—Ç –≤ Vercel –∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞
- –í development —Ä–µ–∂–∏–º–µ —Å–µ–∫—Ä–µ—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

### –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –ø—Ä–æ–¥–ª–µ–≤–∞—é—Ç—Å—è:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `next_billing_date` –≤ –ë–î (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–µ–≥–æ–¥–Ω—è)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ `auto_renew_enabled = true`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ `payment_method_id` –Ω–µ –ø—É—Å—Ç–æ–π
4. –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ cron job –¥–ª—è –¥–µ—Ç–∞–ª–µ–π

---

## üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∏

### GitHub Actions:

`.github/workflows/cron.yml`:
```yaml
name: Renew Subscriptions
on:
  schedule:
    - cron: '0 2 * * *'
jobs:
  renew:
    runs-on: ubuntu-latest
    steps:
      - name: Call cron endpoint
        run: |
          curl -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            https://your-domain.vercel.app/api/cron/renew-subscriptions
```

### Railway/Render:

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ Cron Jobs –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞.

---

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏

‚ö†Ô∏è **Production:**
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `CRON_SECRET` –≤ production
- –õ–æ–≥–∏—Ä—É–π—Ç–µ –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã

üß™ **Development:**
- –°–µ–∫—Ä–µ—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
- –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ curl
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

üìß **TODO:**
- –î–æ–±–∞–≤–∏—Ç—å email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö
- –î–æ–±–∞–≤–∏—Ç—å Slack/Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∞
- –î–æ–±–∞–≤–∏—Ç—å –¥–∞—à–±–æ—Ä–¥ —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –ø—Ä–æ–¥–ª–µ–Ω–∏–π

