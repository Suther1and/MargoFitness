# üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ 012: Yandex ID OAuth

## –û–ø–∏—Å–∞–Ω–∏–µ
–≠—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Yandex ID –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ MargoFitness.

## –ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ù–æ–≤–æ–µ –ø–æ–ª–µ `yandex_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `profiles`
- ‚úÖ –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ `yandex_id`

### 2. Backend
- ‚úÖ `/api/auth/yandex/init` - –∏–Ω–∏—Ü–∏–∞—Ü–∏—è OAuth flow
- ‚úÖ `/api/auth/yandex/callback` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ callback –æ—Ç Yandex

### 3. Frontend
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ Yandex –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ `oauth-buttons.tsx`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã TypeScript —Ç–∏–ø—ã

### 4. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `ENV_TEMPLATE.md`

## üìã –®–∞–≥–∏ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ –≤–∞—à —Ñ–∞–π–ª `.env.local`:

```env
# ============================================
# Yandex ID OAuth Configuration
# ============================================
YANDEX_CLIENT_ID=81370b983cd64ba79bc49dc8d9b215e1
YANDEX_CLIENT_SECRET=ee66c653113e4ceab2fa7f64d4ceff87
```

**–í–∞–∂–Ω–æ:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `NEXT_PUBLIC_SITE_URL` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
```env
# –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
NEXT_PUBLIC_SITE_URL=https://yourdomain.com

# –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ ngrok)
NEXT_PUBLIC_SITE_URL=https://your-subdomain.ngrok.io
```

### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

#### –í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ Supabase Dashboard (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –û—Ç–∫—Ä–æ–π—Ç–µ [Supabase Dashboard](https://app.supabase.com)
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor**
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
   ```
   database/migrations/012_ADD_YANDEX_AUTH.sql
   ```
5. –ù–∞–∂–º–∏—Ç–µ **Run** (F5)

#### –í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ Supabase CLI

```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
supabase db push

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
supabase db execute -f database/migrations/012_ADD_YANDEX_AUTH.sql
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏

–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'profiles' AND column_name = 'yandex_id';

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–∞
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'profiles' AND indexname = 'idx_profiles_yandex_id';
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –°—Ç–æ–ª–±–µ—Ü `yandex_id` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–∏–ø–∞ `text` –∏ –¥–æ–ø—É—Å–∫–∞—Ç—å `NULL`
- –ò–Ω–¥–µ–∫—Å `idx_profiles_yandex_id` –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å

### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Yandex OAuth –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ï—Å–ª–∏ –≤—ã –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Yandex:

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ [OAuth.Yandex](https://oauth.yandex.ru/client/new)
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. –í —Ä–∞–∑–¥–µ–ª–µ **Redirect URI** —É–∫–∞–∂–∏—Ç–µ:
   ```
   https://yourdomain.com/api/auth/yandex/callback
   ```
   –ò–ª–∏ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
   ```
   https://your-subdomain.ngrok.io/api/auth/yandex/callback
   ```
4. –í —Ä–∞–∑–¥–µ–ª–µ **Permissions** –≤—ã–±–µ—Ä–∏—Ç–µ:
   - `login:email` - –¥–æ—Å—Ç—É–ø –∫ email
   - `login:info` - –¥–æ—Å—Ç—É–ø –∫ –∏–º–µ–Ω–∏ –∏ —Ñ–∞–º–∏–ª–∏–∏
   - `login:avatar` - –¥–æ—Å—Ç—É–ø –∫ –∞–≤–∞—Ç–∞—Ä—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **Client ID** –∏ **Client Secret**

### –®–∞–≥ 5: –î–µ–ø–ª–æ–π –Ω–∞ Vercel (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

–ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Vercel –¥–ª—è –¥–µ–ø–ª–æ—è:

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Settings ‚Üí Environment Variables**
2. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
   - `YANDEX_CLIENT_ID` = `81370b983cd64ba79bc49dc8d9b215e1`
   - `YANDEX_CLIENT_SECRET` = `ee66c653113e4ceab2fa7f64d4ceff87`
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `NEXT_PUBLIC_SITE_URL` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤–∞—à –ø—Ä–æ–¥–∞–∫—à–µ–Ω –¥–æ–º–µ–Ω
4. –ù–∞–∂–º–∏—Ç–µ **Save**
5. –ü–µ—Ä–µ–¥–µ–ø–ª–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

### –®–∞–≥ 6: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä (Ctrl+C)
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ
npm run dev
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –í–∏–∑—É–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É `/auth`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ **Yandex** –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
3. –ö–Ω–æ–ø–∫–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "–í—Ö–æ–¥..." –ø—Ä–∏ –∫–ª–∏–∫–µ

### 2. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É **Yandex**
2. –í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Yandex
3. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ Yandex –∞–∫–∫–∞—É–Ω—Ç
4. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Dashboard

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Yandex, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```sql
SELECT id, email, full_name, yandex_id 
FROM profiles 
WHERE yandex_id IS NOT NULL;
```

–î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å—å —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º `yandex_id`.

## üêõ Troubleshooting

### "Yandex OAuth not configured"
‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `YANDEX_CLIENT_ID` –∏ `YANDEX_CLIENT_SECRET` –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `.env.local`  
‚Üí –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### "Invalid redirect_uri"
‚Üí –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Yandex OAuth –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Redirect URI  
‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `NEXT_PUBLIC_SITE_URL` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### "Token exchange failed"
‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `YANDEX_CLIENT_SECRET`  
‚Üí –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –±–∞–∑–µ
‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (F12)  
‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ  
‚Üí –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –±—ã–ª–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ

### "Migration already applied" –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—É—Å–∫–µ
‚Üí –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! –ú–∏–≥—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `IF NOT EXISTS`, –ø–æ—ç—Ç–æ–º—É –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ  
‚Üí –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
```sql
DROP INDEX IF EXISTS idx_profiles_yandex_id;
ALTER TABLE profiles DROP COLUMN IF EXISTS yandex_id;
```

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ OAuth Flow

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "Yandex"
         ‚Üì
/api/auth/yandex/init
         ‚Üì
–†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ Yandex OAuth
         ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è
         ‚Üì
/api/auth/yandex/callback?code=XXX
         ‚Üì
–û–±–º–µ–Ω code –Ω–∞ access_token
         ‚Üì
–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         ‚Üì
–°–æ–∑–¥–∞–Ω–∏–µ/–≤—Ö–æ–¥ –≤ Supabase
         ‚Üì
–†–µ–¥–∏—Ä–µ–∫—Ç –≤ Dashboard
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ Client Secret —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è state –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç CSRF
- ‚úÖ –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ client secret
- ‚úÖ HTTPS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- ‚úÖ Cookies —Å —Ñ–ª–∞–≥–æ–º httpOnly –¥–ª—è –∑–∞—â–∏—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Yandex OAuth Documentation](https://yandex.ru/dev/id/doc/ru/)
- [Yandex API Reference](https://yandex.ru/dev/id/doc/ru/reference/request)
- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 24 –¥–µ–∫–∞–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–ê–≤—Ç–æ—Ä:** AI Assistant


